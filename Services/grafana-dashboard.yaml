apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-microservices
  namespace: monitoring
data:
  microservices-dashboard.json: |
    {
      "dashboard": {
        "title": "Microservices Overview",
        "panels": [
          {
            "title": "Pod CPU Usage",
            "targets": [
              {
                "expr": "sum(rate(container_cpu_usage_seconds_total{pod=~\".*-service\"}[5m])) by (pod)"
              }
            ]
          },
          {
            "title": "Pod Memory Usage",
            "targets": [
              {
                "expr": "sum(container_memory_usage_bytes{pod=~\".*-service\"}) by (pod)"
              }
            ]
          },
          {
            "title": "Service Request Rate",
            "targets": [
              {
                "expr": "sum(rate(http_requests_total{job=~\".*-service\"}[5m])) by (job)"
              }
            ]
          },
          {
            "title": "Service Error Rate",
            "targets": [
              {
                "expr": "sum(rate(http_requests_total{job=~\".*-service\",status=~\"5..\"}[5m])) by (job)"
              }
            ]
          },
          {
            "title": "Pod Restart Count",
            "targets": [
              {
                "expr": "sum(increase(kubernetes_pod_container_status_restarts_total[1h])) by (pod)"
              }
            ]
          },
          {
            "title": "Network I/O",
            "targets": [
              {
                "expr": "sum(rate(container_network_receive_bytes_total{pod=~\".*-service\"}[5m])) by (pod)"
              }
            ]
          }
        ]
      }
    }
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: monitoring
data:
  prometheus.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      url: http://prometheus-kube-prometheus-prometheus:9090
      access: proxy
      isDefault: true
---
apiVersion: v1
kind: Secret
metadata:
  name: grafana-admin-credentials
  namespace: monitoring
type: Opaque
stringData:
  admin-user: admin
  admin-password: admin123
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-alert-notification
  namespace: monitoring
data:
  alerting.yaml: |
    alerting:
      notification_channels:
        - name: "Slack Notification"
          type: "slack"
          settings:
            url: "https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
            channel: "#alerts"
        - name: "Email Notification"
          type: "email"
          settings:
            addresses: "alerts@example.com"
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: system-alerts
  namespace: monitoring
  labels:
    prometheus: kube-prometheus
spec:
  groups:
  - name: system.rules
    interval: 30s
    rules:
    - alert: HighDiskUsage
      expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) > 0.85
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "High disk usage on {{ $labels.device }}"
        description: "Disk {{ $labels.device }} is {{ $value | humanizePercentage }} full"
    
    - alert: KubernetesNodeNotReady
      expr: kube_node_status_condition{condition="Ready",status="true"} == 0
      for: 5m
      labels:
        severity: critical
      annotations:
        summary: "Kubernetes node not ready"
        description: "Node {{ $labels.node }} is not in Ready state"
    
    - alert: KubernetesMemoryPressure
      expr: kube_node_status_condition{condition="MemoryPressure",status="true"} == 1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Kubernetes memory pressure"
        description: "Node {{ $labels.node }} has memory pressure"
    
    - alert: KubernetesDiskPressure
      expr: kube_node_status_condition{condition="DiskPressure",status="true"} == 1
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Kubernetes disk pressure"
        description: "Node {{ $labels.node }} has disk pressure"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-custom-ini
  namespace: monitoring
data:
  grafana.ini: |
    [users]
    allow_sign_up = false
    
    [security]
    admin_user = admin
    admin_password = admin123
    disable_gravatar = true
    
    [paths]
    data = /var/lib/grafana/data
    logs = /var/log/grafana
    plugins = /var/lib/grafana/plugins
    
    [auth]
    disable_login_form = false
    disable_signout_menu = false
    
    [analytics]
    check_for_updates = true
    
    [dashboards]
    default_home_dashboard_path = /var/lib/grafana/dashboards/home.json
